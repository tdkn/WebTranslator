{"version":3,"file":"background.js","mappings":"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","sources":["webpack://webtranslator/./src/background/translator.js","webpack://webtranslator/webpack/bootstrap","webpack://webtranslator/webpack/runtime/define property getters","webpack://webtranslator/webpack/runtime/hasOwnProperty shorthand","webpack://webtranslator/webpack/runtime/make namespace object","webpack://webtranslator/./src/background/background.js"],"sourcesContent":["\"use strict\";\n\nexport class Translator {\n  #id = 1e4 * Math.round(1e4 * Math.random());\n\n  #sourceLanguage;\n  #targetLanguage;\n\n  constructor() {}\n\n  setSourceLanguage(sourceLanguage) {\n    this.#sourceLanguage = sourceLanguage;\n  }\n\n  setTargetLanguage(targetLanguage) {\n    this.#targetLanguage = targetLanguage;\n  }\n\n  async translate(texts, isHtmlEnabled = true) {\n    this.#id++;\n\n    let n = 1;\n    for (const text of texts) {\n      for (let i = 0; i < text.length; i++) {\n        if (text[i] === \"i\") {\n          n++;\n        }\n      }\n    }\n\n    let timestamp = Date.now();\n    timestamp = timestamp - (timestamp % n) + n;\n\n    let body = JSON.stringify({\n      jsonrpc: \"2.0\",\n      method: \"LMT_handle_texts\",\n      params: {\n        texts: texts.map((text) => {\n          return {\n            text,\n          };\n        }),\n        html: isHtmlEnabled ? \"enabled\" : undefined,\n        splitting: isHtmlEnabled ? undefined : \"newlines\",\n        lang: {\n          target_lang: this.#targetLanguage,\n          source_lang_user_selected: this.#sourceLanguage || \"auto\",\n        },\n        timestamp,\n      },\n      id: this.#id,\n    });\n    body = body.replace(\n      `\"method\":\"`,\n      `${\n        (this.#id + 3) % 13 === 0 || (this.#id + 5) % 29 === 0\n          ? `\"method\" : \"`\n          : `\"method\": \"`\n      }`\n    );\n\n    const request = {\n      method: isHtmlEnabled ? \"translate\" : \"translateSelection\",\n      payload: {\n        headers: {\n          Accept: \"*/*\",\n          \"x-app-os-name\": \"iOS\",\n          \"Accept-Encoding\": \"gzip, deflate, br\",\n          \"Content-Type\": \"application/json\",\n          Referer: \"https://www.deepl.com/\",\n        },\n        method: \"POST\",\n        body: body,\n      },\n    };\n\n    return new Promise((resolve) => {\n      browser.runtime.sendNativeMessage(\n        \"application.id\",\n        request,\n        (response) => {\n          if (response && response.result) {\n            resolve(response.result);\n          } else {\n            resolve(undefined);\n          }\n        }\n      );\n    });\n  }\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","\"use strict\";\n\nimport { Translator } from \"./translator\";\n\nclass App {\n  #selectionText = undefined;\n\n  constructor() {\n    this.#init();\n  }\n\n  #init() {\n    this.#setupListeners();\n    this.#setupContextMenu();\n  }\n\n  #setupListeners() {\n    browser.runtime.onMessage.addListener((request, sender, sendResponse) => {\n      if (!request) {\n        return;\n      }\n      switch (request.method) {\n        case \"translate\": {\n          const texts = request.texts;\n          translate(texts, request.sourceLanguage, request.targetLanguage)\n            .then((result) => {\n              sendResponse({ result });\n            })\n            .catch((error) => {\n              sendResponse();\n            });\n          break;\n        }\n        case \"translateSelection\": {\n          const selectionText = this.#selectionText;\n          if (request.selectionText && request.selectionText.trim()) {\n            // From popup toolbar (Mobile only)\n            this.#translateSelection(request.selectionText);\n          } else if (selectionText && selectionText.trim()) {\n            // Language changed in popover window\n            this.#translateSelection(selectionText);\n          }\n\n          sendResponse();\n          break;\n        }\n        default: {\n          sendResponse();\n          break;\n        }\n      }\n\n      return true;\n    });\n  }\n\n  #setupContextMenu() {\n    if (browser.menus.create) {\n      browser.menus.create({\n        id: \"translateSelection\",\n        title: browser.i18n.getMessage(\"context_menus_translate_section\"),\n        contexts: [\"editable\", \"link\", \"page\", \"selection\"],\n      });\n\n      browser.menus.onClicked.addListener(async (info, tab) => {\n        switch (info.menuItemId) {\n          case \"translateSelection\":\n            const selectionText = info.selectionText;\n            if (selectionText && selectionText.trim()) {\n              this.#translateSelection(selectionText);\n            }\n        }\n      });\n    }\n  }\n\n  async #translateSelection(selectionText) {\n    const results = await browser.tabs.executeScript({\n      code: `if (!window.customElements.get(\"translate-popover\")) { true; }`,\n    });\n    if (results && results[0]) {\n      await browser.tabs.executeScript({\n        file: \"/translate_ui.js\",\n      });\n    }\n\n    const tabs = await browser.tabs.query({\n      active: true,\n      currentWindow: true,\n    });\n    const response = await browser.tabs.sendMessage(tabs[0].id, {\n      method: \"ping\",\n    });\n    if (!response) {\n      await browser.tabs.executeScript({\n        file: \"/translate.js\",\n      });\n    }\n\n    this.#selectionText = selectionText;\n    const targetLanguage = await getTargetLanguage();\n\n    browser.tabs.query({ active: true, currentWindow: true }, (tabs) => {\n      browser.tabs.sendMessage(tabs[0].id, {\n        method: \"startTranslateSelection\",\n        selectionText,\n      });\n    });\n\n    const result = await translate(\n      [selectionText],\n      undefined,\n      targetLanguage,\n      false\n    );\n\n    browser.tabs.query({ active: true, currentWindow: true }, (tabs) => {\n      browser.tabs.sendMessage(tabs[0].id, {\n        method: \"finishTranslateSelection\",\n        result,\n        targetLanguage,\n      });\n    });\n    browser.runtime.sendMessage({\n      method: \"finishTranslateSelection\",\n    });\n  }\n}\n\nasync function translate(\n  texts,\n  sourceLanguage,\n  targetLanguage,\n  isHtmlEnabled = true\n) {\n  const translator = new Translator();\n  translator.setSourceLanguage(sourceLanguage);\n  translator.setTargetLanguage(targetLanguage);\n\n  const result = await translator.translate(texts, isHtmlEnabled);\n  return result;\n}\n\nasync function getTargetLanguage() {\n  return new Promise((resolve, reject) => {\n    browser.storage.local.get([\"selectedTargetLanguage\"], (result) => {\n      if (result && result.selectedTargetLanguage) {\n        resolve(result.selectedTargetLanguage);\n      } else {\n        const locale = browser.i18n\n          .getUILanguage()\n          .split(\"-\")\n          .shift()\n          .toUpperCase();\n        resolve(locale);\n      }\n    });\n  });\n}\n\nnew App();\n"],"names":["Translator","constructor","Math","round","random","setSourceLanguage","sourceLanguage","setTargetLanguage","targetLanguage","translate","texts","isHtmlEnabled","n","text","i","length","timestamp","Date","now","body","JSON","stringify","jsonrpc","method","params","map","html","undefined","splitting","lang","target_lang","source_lang_user_selected","id","replace","request","payload","headers","Accept","Referer","Promise","resolve","browser","runtime","sendNativeMessage","response","result","App","onMessage","addListener","sender","sendResponse","then","catch","error","selectionText","trim","menus","create","title","i18n","getMessage","contexts","onClicked","info","tab","menuItemId","results","tabs","executeScript","code","file","query","active","currentWindow","sendMessage","getTargetLanguage","translator","reject","storage","local","get","selectedTargetLanguage","locale","getUILanguage","split","shift","toUpperCase"],"sourceRoot":""}